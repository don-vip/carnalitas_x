namespace = carnx_slave

# Buy Foreign Slaves
carnx_slave.0001 = {
	type = character_event
	title = carnx_slave.0001.t
	desc = carnx_slave.0001.desc

	theme = dungeon
	left_portrait = {
		character = scope:valuable_option
		animation = shame
	}
	right_portrait = {
		character = scope:common_option
		animation = sadness
	}

	trigger = {
		NOT = { has_game_rule = carn_slavery_content_disabled }
		exists = capital_province
		any_independent_ruler = {
			NOR = {
				faith = root.faith
				culture = root.culture
			}
			root = {
				NOT = { carnx_is_slavery_crime_trigger = { CHARACTER = prev } }
			}
		}
	}

	immediate = {
		hidden_effect = {
			random_independent_ruler = {
				limit = {
					is_landed = yes
					NOR = {
						faith = root.faith
						culture = root.culture
					}
					root = {
						NOT = { carnx_is_slavery_crime_trigger = { CHARACTER = prev } }
					}
				}
				weight = {
					# Nearby rulers more likely
					base = 1
					modifier = {
						capital_province = { squared_distance = { target = root.capital_province value <= squared_distance_small } }
						factor = 2
					}
					modifier = {
						capital_province = { squared_distance = { target = root.capital_province value <= squared_distance_medium } }
						factor = 2
					}
					modifier = {
						capital_province = { squared_distance = { target = root.capital_province value <= squared_distance_large } }
						factor = 2
					}
					modifier = {
						capital_province = { squared_distance = { target = root.capital_province value <= squared_distance_huge } }
						factor = 2
					}
					modifier = {
						capital_province = { squared_distance = { target = root.capital_province value <= squared_distance_almost_massive } }
						factor = 2
					}
					modifier = {
						capital_province = { squared_distance = { target = root.capital_province value <= squared_distance_massive } }
						factor = 2
					}
					modifier = {
						capital_province = { squared_distance = { target = root.capital_province value <= squared_distance_monstrous } }
						factor = 2
					}
				}
				save_scope_as = foreign_ruler
			}

			if = {
				limit = { exists = scope:foreign_ruler }

				# Valuable option
				random_list = {
					10 = {
						# Diplomacy: Chancellor, Cupbearer, Court Jester, Court Poet, Court Musician
						create_character = {
							#name = "Diplomacy"
							location = root.capital_province
							template = pool_repopulate_diplomacy
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							diplomacy = { min_template_average_skill max_template_decent_skill }
							random_traits_list = {
								count = { 0 1 }
								# Cupbearer
								honest = {}
								trusting = {}
								# Court Jester, Court Poet, Court Musician
								gregarious = {}
								stubborn = {}
								shrewd = {}
								poet = {}
								athletic = {}
							}
							gender_female_chance = carnx_root_faith_dominant_gender_adjusted_female_chance
							save_scope_as = valuable_option
						}
					}
					10 = {
						# Martial: Marhsal, Commanders
						create_character = {
							#name = "Martial"
							location = root.capital_province
							template = pool_repopulate_martial
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							martial = { min_template_average_skill max_template_decent_skill }
							random_traits_list = {
								count = { 0 1 }
								# Commander traits
								aggressive_attacker = {}
								flexible_leader = {}
								forder = {}
								holy_warrior = {}
								logistician = {}
								military_engineer = {}
								organizer = {}
								reaver = {}
								unyielding_defender = {}
								cautious_leader = {}
								reckless = {}
								open_terrain_expert = {}
							}
							gender_female_chance = root_faith_dominant_gender_adjusted_female_chance
							save_scope_as = valuable_option
						}
					}
					10 = {
						# Stewardship: Steward, Court Gardener, Seneschal
						create_character = {
							#name = "Stewardship"
							location = root.capital_province
							template = pool_repopulate_stewardship
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							stewardship = { min_template_average_skill max_template_decent_skill }
							random_traits_list = {
								count = { 0 1 }
								# Court Gardener
								lifestyle_gardener = {}
								lifestyle_herbalist = {}
								patient = {}
								architect = {}
								# Seneschal
								administrator = {}
								overseer = {}
							}
							gender_female_chance = carnx_root_faith_dominant_gender_adjusted_female_chance
							save_scope_as = valuable_option
						}
					}
					10 = {
						# Intrigue: Spymaster, Food Taster, Executioner
						create_character = {
							#name = "Intrigue"
							location = root.capital_province
							template = pool_repopulate_intrigue
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							intrigue = { min_template_average_skill max_template_decent_skill }
							random_traits_list = {
								count = { 0 1 }
								# Food Taster
								gluttonous = {}
								comfort_eater = {}
								lifestyle_herbalist = {}
								# Executioner
								torturer = {}
								sadistic = {}
							}
							gender_female_chance = carnx_create_character_female_chance
							save_scope_as = valuable_option
						}
					}
					10 = {
						# Learning: Court Physician, Antiquarian, Court Tutor, Court Poet (secondary)
						create_character = {
							#name = "Learning"
							location = root.capital_province
							template = pool_repopulate_learning
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							learning = { min_template_average_skill max_template_decent_skill }
							random_traits_list = {
								count = { 0 1 }
								# Court Physician
								physician_1 = {}
								physician_2 = {}
								physician_3 = {}
								mystic_1 = {}
								mystic_2 = {}
								mystic_3 = {}
								lifestyle_herbalist = {}
								# Antiquarian
								shy = {}
								administrator = {}
								# Court Tutor
								patient = {}
								intellect_good_1 = {}
								intellect_good_2 = {}
								shrewd = {}
								# Court Poet
								gregarious = {}
							}
							gender_female_chance = carnx_create_character_female_chance
							save_scope_as = valuable_option
						}
					}
					10 = {
						# Prowess: Knights, Bodyguard, Champion
						create_character = {
							#name = "Prowess"
							location = root.capital_province
							template = pool_repopulate_prowess
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							prowess = { min_template_average_skill max_template_decent_skill }
							gender_female_chance = root_soldier_female_chance
							save_scope_as = valuable_option
						}
					}
					5 = {
						modifier = {
							root.culture = { has_cultural_parameter = can_appoint_chief_eunuch }
							add = 5
						}
						# Eunuch: Chief Eunuch
						create_character = {
							#name = "Eunuch"
							location = root.capital_province
							template = carnx_eunuch_character_template
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							save_scope_as = valuable_option
						}
					}
					10 = {
						modifier = {
							root = { carnx_slave_concubine_court_position_enabled_trigger = yes }
							add = 20
						}
						# Concubine: Slave Concubine
						create_character = {
							#name = "Concubine"
							location = root.capital_province
							template = carnx_concubine_character_template
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							save_scope_as = valuable_option
						}
					}
					5 = {
						modifier = {
							root = { carnx_slave_captain_court_position_enabled_trigger = yes }
							add = 10
						}
						# Captain: Slave Captain
						create_character = {
							#name = "Captain"
							location = root.capital_province
							template = carnx_soldier_character_template
							culture = scope:foreign_ruler.culture
							faith = scope:foreign_ruler.faith
							save_scope_as = valuable_option
						}
					}
				}

				# Common option
				create_character = {
					location = root.capital_province
					template_character = scope:foreign_ruler
					gender_female_chance = carnx_create_character_female_chance
					age = { 16 40 }
					dynasty = none
					random_traits = yes
					save_scope_as = common_option
				}
			}

			if = {
				limit = { exists = scope:valuable_option }
				scope:valuable_option = {
					if = {
						limit = { carnx_enable_nudity = yes }
						add_character_flag = is_naked
					}
					save_scope_value_as = {
						name = valuable_option_price
						value = {
							value = carnx_slave_base_price_value
							if = {
								limit = { root = { is_ai = no } }
								multiply = carnx_slave_ask_price_player_multiplier
							}
							else = {
								multiply = carnx_slave_bid_price_player_multiplier
							}
							multiply = carnx_slave_price_tribal_multiplier
							floor = yes
							min = 1
						}
					}
					save_scope_as = slave
				}
				save_scope_value_as = {
					name = valuable_option_ai_accept_value
					value = {
						value = carnx_sell_slave_ai_accept_no_actor_value
						add = {
							value = 100 # Assume max opinion to make it more likely
							multiply = carnx_buy_sell_slave_ai_opinion_multiplier
						}
						min = 0
					}
				}
			}

			if = {
				limit = { exists = scope:common_option }
				scope:common_option = {
					if = {
						limit = { carnx_enable_nudity = yes }
						add_character_flag = is_naked
					}
					save_scope_value_as = {
						name = common_option_price
						value = {
							value = carnx_slave_base_price_value
							if = {
								limit = { root = { is_ai = no } }
								multiply = carnx_slave_ask_price_player_multiplier
							}
							else = {
								multiply = carnx_slave_bid_price_player_multiplier
							}
							multiply = carnx_slave_price_tribal_multiplier
							floor = yes
							min = 1
						}
					}
					save_scope_as = slave
				}
				save_scope_value_as = {
					name = common_option_ai_accept_value
					value = {
						value = carnx_sell_slave_ai_accept_no_actor_value
						add = {
							value = 100 # Assume max opinion to make it more likely
							multiply = carnx_buy_sell_slave_ai_opinion_multiplier
						}
						min = 0
					}
				}
			}
		}
	}

	# Valuable option
	option = {
		name = carnx_slave.0001.a

		trigger = {
			exists = scope:valuable_option
			short_term_gold >= scope:valuable_option_price
			is_landed = yes # Extra check to make sure they haven't lost their status
		}
		show_as_unavailable = { exists = scope:valuable_option }

		remove_short_term_gold = scope:valuable_option_price

		hidden_effect = {
			if = {
				limit = { carnx_enable_nudity = yes }
				scope:valuable_option = { remove_character_flag = is_naked }
			}
			if = {
				limit = { exists = scope:common_option }
				scope:common_option = { silent_disappearance_effect = yes }
			}
			debug_log = "Buy Slaves valuable option chosen"
		}

		carn_enslave_effect = {
			SLAVE = scope:valuable_option
			OWNER = root
			DRAMA = no
		}

		scope:valuable_option = {
			add_character_flag = {
				flag = carnx_slave_recently_bought
				years = 2
			}
		}

		ai_chance = {
			base = 0
			modifier = {
				always = yes
				add = scope:valuable_option_ai_accept_value
			}
			modifier = {
				short_term_gold < medium_gold_value
				factor = 0
			}
		}
	}

	# Common option
	option = {
		name = carnx_slave.0001.b

		trigger = {
			exists = scope:common_option
			short_term_gold >= scope:common_option_price
			is_landed = yes # Extra check to make sure they haven't lost their status
		}
		show_as_unavailable = { exists = scope:common_option }

		remove_short_term_gold = scope:common_option_price

		hidden_effect = {
			if = {
				limit = { carnx_enable_nudity = yes }
				scope:common_option = { remove_character_flag = is_naked }
			}
			if = {
				limit = { exists = scope:valuable_option }
				scope:valuable_option = { silent_disappearance_effect = yes }
			}
			debug_log = "Buy Slaves common option chosen"
		}

		carn_enslave_effect = {
			SLAVE = scope:common_option
			OWNER = root
			DRAMA = no
		}

		scope:common_option = {
			add_character_flag = {
				flag = carnx_slave_recently_bought
				years = 2
			}
		}

		ai_chance = {
			base = 0
			modifier = {
				always = yes
				add = scope:common_option_ai_accept_value
			}
			modifier = {
				short_term_gold < medium_gold_value
				factor = 0
			}
		}
	}

	# None...
	option = {
		name = carnx_slave.0001.c

		hidden_effect = {
			if = {
				limit = { exists = scope:valuable_option }
				scope:valuable_option = { silent_disappearance_effect = yes }
			}
			if = {
				limit = { exists = scope:common_option }
				scope:common_option = { silent_disappearance_effect = yes }
			}
		}

		ai_chance = {
			factor = 1
		}
	}
}
