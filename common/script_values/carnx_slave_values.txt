# Slave base price. Based on individual_recruit_guest_interaction_cost.
carnx_slave_base_price_value = {
	add = 10

	# Claims (100 to 250 depending on the highest claim tier)
	if = {
		limit = {
			any_claim = { always = yes }
		}
		if = {
			limit = {
				any_claim = {
					tier = tier_empire
				}
			}
			add = 250
		}
		else_if = {
			limit = {
				any_claim = {
					tier = tier_kingdom
				}
			}
			add = 200
		}
		else_if = {
			limit = {
				any_claim = {
					tier = tier_duchy
				}
			}
			add = 150
		}
		else_if = {
			limit = {
				any_claim = {
					tier = tier_county
				}
			}
			add = 100
		}
	}

	# Dynasty (5 for each dynasty prestige level)
	if = {
		limit = {
			exists = dynasty
		}
		add = {
			value = dynasty.dynasty_prestige_level # 0-10
			multiply = 5 # Max 50, reduced compared to guests (15 -> 5)
		}
	}

	# Genetic traits (genetic character value multiplied by 5)
	add = {
		value = genetic_character_value
		multiply = 5
		min = -15
	}

	# Commander traits (15 for each commander trait)
	if = {
		limit = {
			number_of_commander_traits >= 1
		}
		add = {
			value = number_of_commander_traits
			multiply = 15
			min = 0
		}
	}

	# Court Physician traits (10 to 20 depending on tier)
	if = {
		limit = {
			OR = {
				has_trait = physician_3
				has_trait = mystic_3
			}
		}
		add = 20
	}
	else_if = {
		limit = {
			OR = {
				has_trait = lifestyle_herbalist
				has_trait = physician_2
				has_trait = mystic_2
			}
		}
		add = 15
	}
	else_if = {
		limit = {
			OR = {
				has_trait = physician_1
				has_trait = mystic_1
			}
		}
		add = 10
	}

	# TODO: Other traits

	# Skills (5 for each skill point above 12)
	if = {
		limit = {
			diplomacy >= decent_skill_rating
		}
		add = {
			value = diplomacy
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			martial >= decent_skill_rating
		}
		add = {
			value = martial
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			stewardship >= decent_skill_rating
		}
		add = {
			value = stewardship
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			intrigue >= decent_skill_rating
		}
		add = {
			value = intrigue
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			learning >= decent_skill_rating
		}
		add = {
			value = learning
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			prowess >= decent_skill_rating
		}
		add = {
			value = prowess
			subtract = decent_skill_rating
			multiply = 5
		}
	}

	# Attraction (-10 to 20 depending on attraction)
	add = {
		value = attraction
		divide = high_positive_attraction
		multiply = 20
		min = -10
	}

	# Visibly fertile females (20)
	if = {
		limit = {
			is_female = yes
			is_visibly_fertile = yes
		}
		add = 20
	}

	# TODO: Tribal rulers pay less (multiply by 0.25)

	# Apply a correction factor to get the final price
	multiply = carnx_slave_base_price_multiplier

	min = 1
}

carnx_slave_ask_price_value = {
	value = carnx_slave_base_price_value

	# Make it higher for the player
	if = {
		limit = { scope:actor = { is_ai = no } }
		multiply = carnx_slave_ask_price_player_multiplier
	}

	# Seller personality multiplier (0.8 to 1.2 based on ai_greed)
	multiply = {
		value = scope:seller.ai_greed
		multiply = 0.002
		add = 1
	}
}

carnx_slave_bid_price_value = {
	value = carnx_slave_base_price_value

	# Make it lower for the player
	if = {
		limit = { scope:actor = { is_ai = no } }
		multiply = carnx_slave_bid_price_player_multiplier
	}

	# Buyer personality multiplier (0.8 to 1.2 based on ai_greed)
	multiply = {
		value = scope:buyer.ai_greed
		multiply = -0.002
		add = 1
	}
}

carnx_buy_slave_ai_accept_no_actor_value = {
	save_temporary_scope_as = slave
	value = 50

	# Employed as councillor (-50), court position, knight / commander, or in some other way (-25)
	if = {
		limit = {
			scope:slave = {
				is_councillor_of = scope:seller
			}
		}
		add = -50
	}
	if = {
		limit = {
			scope:slave = {
				AND = {
					has_any_court_position = yes
					any_court_position_employer = { this = scope:seller }
				}
			}
		}
		add = -25
	}
	if = {
		limit = {
			scope:slave = {
				OR = {
					is_knight_of = scope:seller
					is_commanding_army = yes
				}
			}
		}
		add = -25
	}
	if = {
		limit = {
			scope:slave = {
				carnx_has_important_role_trigger = { RULER = scope:seller }
			}
		}
		add = -25
	}

	# Family and relations (-25 to -100 depending on how close the relation)
	# Reluctant to sell family and relations, wants to free them instead
	if = {
		limit = {
			scope:slave = {
				carnx_is_family_or_positive_relation_trigger = { CHARACTER = scope:seller }
			}
		}
		add = {
			value = -25
			if = {
				limit = {
					scope:slave = {
						OR = {
							is_child_of = scope:seller
							has_relation_best_friend = scope:seller
							has_relation_soulmate = scope:seller
						}
					}
				}
				multiply = 4
			}
			else_if = {
				limit = {
					scope:slave = {
						OR = {
							is_close_family_of = scope:seller
							has_relation_friend = scope:seller
							has_relation_lover = scope:seller
							has_secret_relation_lover = scope:seller
							has_relation_crush = scope:seller
							is_spouse_of = scope:seller
						}
					}
				}
				multiply = 3
			}
			else_if = {
				limit = {
					scope:slave = {
						is_close_or_extended_family_of = scope:seller
					}
				}
				multiply = 2
			}
		}
	}

	# Claims (-50 if useful claims on neighbouring realms)
	if = {
		limit = {
			scope:slave = {
				any_claim = {
					neighboring_useful_courtier_or_guest_claim_trigger = { RULER = scope:seller }
				}
			}
		}
		add = -50
	}

	# Attraction (0 to -50 depending on attraction, doubled for lustful, halved for chaste)
	if = {
		limit = {
			scope:seller = {
				is_attracted_to_gender_of = scope:slave
			}
			scope:slave.attraction > 0
		}
		add = {
			value = scope:slave.attraction
			divide = high_positive_attraction
			if = {
				limit = { scope:seller = { has_trait = lustful } }
				multiply = -100
			}
			else_if = {
				limit = { scope:seller = { has_trait = chaste } }
				multiply = -25
			}
			else = {
				multiply = -50
			}
		}
	}

	# Female (-25 if a visibly fertile female)
	if = {
		limit = {
			scope:slave = {
				is_female = yes
				is_visibly_fertile = yes
			}
		}
		add = -25
	}
}

carnx_buy_slave_ai_accept_value = {
	value = carnx_buy_slave_ai_accept_no_actor_value
	save_temporary_scope_as = slave

	# Opinion of actor (-12 to 12 depending on opinion)
	add = {
		value = scope:opinion_of_actor
		multiply = carnx_buy_sell_slave_opinion_multiplier
	}

	# Avoid doing business with rivals or nemesises
	if = {
		limit = {
			scope:seller = {
				has_relation_rival = scope:actor
			}
		}
		add = -100
	}
	if = {
		limit = {
			scope:seller = {
				has_relation_nemesis = scope:actor
			}
		}
		add = -200
	}

	# Not enough gold
	if = {
		limit = {
			scope:actor.gold < scope:slave.carnx_slave_ask_price_value
		}
		multiply = 0
	}
}

carnx_sell_slave_ai_accept_no_actor_value = {
	save_temporary_scope_as = buyer
	value = -50

	# Avoid spending money if at war
	if = {
		limit = {
			scope:buyer = {
				is_at_war = yes
			}
		}
		add = -50
	}

	# Slavery crime (-100) or shunned by faith (-50)
	if = {
		limit = {
			scope:buyer = {
				carnx_is_slavery_crime_trigger = { CHARACTER = scope:slave }
			}
		}
		add = -1000
	}
	if = {
		limit = {
			scope:buyer = {
				carnx_is_slavery_shunned_trigger = { CHARACTER = scope:slave }
			}
		}
		add = -50
	}

	# Lacking councillors, court physician, or knights (5 for each relevant skill above 12)
	if = {
		limit = {
			scope:slave = {
				diplomacy >= decent_skill_rating
				can_be_chancellor_trigger = { COURT_OWNER = scope:buyer }
			}
			scope:buyer = {
				OR = {
					NOT = { exists = cp:councillor_chancellor }
					cp:councillor_chancellor = { diplomacy < decent_skill_rating }
				}
			}
		}
		add = {
			value = scope:slave.diplomacy
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			scope:slave = {
				martial >= decent_skill_rating
				can_be_marshal_trigger = { COURT_OWNER = scope:buyer }
			}
			scope:buyer = {
				OR = {
					NOT = { exists = cp:councillor_marshal }
					cp:councillor_marshal = { martial < decent_skill_rating }
				}
			}
		}
		add = {
			value = scope:slave.martial
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			scope:slave = {
				stewardship >= decent_skill_rating
				can_be_steward_trigger = { COURT_OWNER = scope:buyer }
			}
			scope:buyer = {
				OR = {
					NOT = { exists = cp:councillor_steward }
					cp:councillor_steward = { stewardship < decent_skill_rating }
				}
			}
		}
		add = {
			value = scope:slave.stewardship
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			scope:slave = {
				intrigue >= decent_skill_rating
				can_be_spymaster_trigger = { COURT_OWNER = scope:buyer }
			}
			scope:buyer = {
				OR = {
					NOT = { exists = cp:councillor_spymaster }
					cp:councillor_spymaster = { intrigue < decent_skill_rating }
				}
			}
		}
		add = {
			value = scope:slave.intrigue
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			scope:slave = {
				learning >= decent_skill_rating
				can_be_court_physician_of = { EMPLOYER = scope:buyer }
			}
			scope:buyer = {
				court_physician_available_trigger = no
			}
		}
		add = {
			value = scope:slave.learning
			subtract = decent_skill_rating
			multiply = 5
		}
	}
	if = {
		limit = {
			scope:slave = {
				prowess >= decent_skill_rating
				can_be_knight_trigger = { ARMY_OWNER = scope:buyer }
			}
			scope:buyer = {
				OR = {
					number_of_knights < max_number_of_knights
					any_knight = {
						prowess < decent_skill_rating
					}
				}
			}
		}
		add = {
			value = scope:slave.prowess
			subtract = decent_skill_rating
			multiply = 5
		}
	}

	# Family and relations (-25 to -100 depending on how close the relation)
	# Reluctant to buy family and relations, wants to ransom them instead
	if = {
		limit = {
			scope:slave = {
				carnx_is_family_or_positive_relation_trigger = { CHARACTER = scope:buyer }
			}
		}
		add = {
			value = -25
			if = {
				limit = {
					scope:slave = {
						OR = {
							is_child_of = scope:buyer
							has_relation_best_friend = scope:buyer
							has_relation_soulmate = scope:buyer
						}
					}
				}
				multiply = 4
			}
			else_if = {
				limit = {
					scope:slave = {
						OR = {
							is_close_family_of = scope:buyer
							has_relation_friend = scope:buyer
							has_relation_lover = scope:buyer
							has_secret_relation_lover = scope:buyer
							has_relation_crush = scope:buyer
							is_spouse_of = scope:buyer
						}
					}
				}
				multiply = 3
			}
			else_if = {
				limit = {
					scope:slave = {
						is_close_or_extended_family_of = scope:buyer
					}
				}
				multiply = 2
			}
		}
	}

	# Claims (50 if useful claims on neighbouring realms)
	if = {
		limit = {
			scope:slave = {
				any_claim = {
					neighboring_useful_courtier_or_guest_claim_trigger = { RULER = scope:buyer }
				}
			}
		}
		add = 50
	}

	# Attraction (0 to 50 depending on attraction, doubled for lustful, halved for chaste)
	if = {
		limit = {
			scope:buyer = {
				is_attracted_to_gender_of = scope:slave
			}
			scope:slave.attraction > 0
		}
		add = {
			value = scope:slave.attraction
			divide = high_positive_attraction
			multiply = 50
			if = {
				limit = { scope:buyer = { has_trait = lustful } }
				multiply = 2
			}
			else_if = {
				limit = { scope:buyer = { has_trait = chaste } }
				multiply = 0.5
			}
		}
	}

	# Female (25 if a visibly fertile female)
	if = {
		limit = {
			scope:slave = {
				is_female = yes
				is_visibly_fertile = yes
			}
		}
		add = 25
	}
}

carnx_sell_slave_ai_accept_value = {
	value = carnx_sell_slave_ai_accept_no_actor_value

	# Opinion of actor (-12 to 12 depending on opinion)
	add = {
		value = scope:opinion_of_actor
		multiply = carnx_buy_sell_slave_opinion_multiplier
	}

	# Avoid doing business with rivals or nemesises
	if = {
		limit = {
			scope:buyer = {
				has_relation_rival = scope:actor
			}
		}
		add = -100
	}
	if = {
		limit = {
			scope:buyer = {
				has_relation_nemesis = scope:actor
			}
		}
		add = -200
	}

	if = {
		limit = {
			scope:buyer.short_term_gold < medium_gold_value
		}
		multiply = 0
	}
}

carnx_slave_ransom_cost_value = {
	value = 0

	# TODO Use define:NImprisonment|RANSOM_COST_BY_TIER if possible
	scope:recipient = {
		if = {
			limit = { highest_held_title_tier = tier_empire }
			add = 500
		}
		else_if = {
			limit = { highest_held_title_tier = tier_kingdom }
			add = 200
		}
		else_if = {
			limit = { highest_held_title_tier = tier_duchy }
			add = 100
		}
		else_if = {
			limit = { highest_held_title_tier = tier_county }
			add = 50
		}
		else_if = {
			limit = { highest_held_title_tier = tier_barony }
			add = 30
		}
		else = {
			add = 20
		}
	}

	if = {
		limit = { is_primary_heir_of = scope:recipient }
		multiply = define:NImprisonment|RANSOM_MULTIPLIER_PRIMARY_HEIR
	}
	else_if = {
		limit = { is_spouse_of = scope:recipient }
		multiply = define:NImprisonment|RANSOM_MULTIPLIER_SPOUSE
	}
	else_if = {
		limit = { is_close_family_of = scope:recipient }
		multiply = define:NImprisonment|RANSOM_MULTIPLIER_CLOSE_FAMILY
	}
	else = {
		multiply = define:NImprisonment|RANSOM_MULTIPLIER_OTHER
	}

	min = define:NImprisonment|RANSOM_MIN_COST

	# Round up to the closest number divisible by RANSOM_ROUNDED_TO
	divide = define:NImprisonment|RANSOM_ROUNDED_TO
	ceiling = yes
	multiply = define:NImprisonment|RANSOM_ROUNDED_TO
}

carnx_enslave_tyranny_gain = {
	value = carnx_enslave_basic_tyranny_gain
	if = {
		limit = {
			exists = scope:new_slave
			scope:new_slave = {
				has_no_real_status_trigger = yes
			}
		}
		divide = 2
	}
}

carn_scope_buyer_current_gold_value = {
	value = scope:buyer.short_term_gold
}